<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrera - Bibliotekssystem</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .register-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            padding: 40px;
            max-width: 500px;
            width: 100%;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 12px;
        }
        .password-requirements {
            font-size: 0.875rem;
            color: #6c757d;
        }
        .field-error {
            color: #dc3545;
            font-size: 0.875rem;
            margin-top: 5px;
        }
        .valid-feedback {
            color: #28a745;
            font-size: 0.875rem;
        }
        .csrf-info {
            font-size: 0.8rem;
            color: #6c757d;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
<div class="register-container">
    <div class="text-center mb-4">
        <h2>üìö Skapa konto</h2>
        <p class="text-muted">Registrera dig f√∂r att b√∂rja anv√§nda bibliotekssystemet</p>
    </div>

    <!-- CSRF-status -->
    <div id="csrfStatus" class="csrf-info text-center">
        üîí H√§mtar s√§kerhetstoken...
    </div>

    <div id="alertBox" class="alert d-none" role="alert"></div>

    <form id="registerForm">
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="firstName" class="form-label">F√∂rnamn</label>
                <input type="text"
                       class="form-control"
                       id="firstName"
                       required
                       minlength="2"
                       maxlength="50">
                <div class="field-error d-none" id="firstNameError"></div>
            </div>

            <div class="col-md-6 mb-3">
                <label for="lastName" class="form-label">Efternamn</label>
                <input type="text"
                       class="form-control"
                       id="lastName"
                       required
                       minlength="2"
                       maxlength="50">
                <div class="field-error d-none" id="lastNameError"></div>
            </div>
        </div>

        <div class="mb-3">
            <label for="email" class="form-label">E-postadress</label>
            <input type="email"
                   class="form-control"
                   id="email"
                   required
                   placeholder="din.email@exempel.com">
            <div class="field-error d-none" id="emailError"></div>
        </div>

        <div class="mb-3">
            <label for="password" class="form-label">L√∂senord</label>
            <input type="password"
                   class="form-control"
                   id="password"
                   required>
            <div class="password-requirements mt-2">
                <div id="lengthCheck">‚ùå Minst 8 tecken</div>
                <div id="letterCheck">‚ùå Inneh√•ller bokst√§ver</div>
                <div id="numberCheck">‚ùå Inneh√•ller siffror</div>
            </div>
            <div class="field-error d-none" id="passwordError"></div>
        </div>

        <div class="mb-3">
            <label for="confirmPassword" class="form-label">Bekr√§fta l√∂senord</label>
            <input type="password"
                   class="form-control"
                   id="confirmPassword"
                   required>
            <div class="field-error d-none" id="confirmPasswordError"></div>
            <div class="valid-feedback d-none" id="passwordMatch">‚úÖ L√∂senorden matchar</div>
        </div>

        <button type="submit" class="btn btn-primary w-100 mb-3" id="registerBtn">
            Skapa konto
        </button>

        <div class="text-center">
            <p class="mb-0">Har du redan ett konto?
                <a href="/login.html">Logga in h√§r</a>
            </p>
        </div>
    </form>

    <div class="mt-3 text-center">
        <small class="text-muted">üîí Skyddat med BCrypt-kryptering och CSRF-skydd</small>
    </div>
</div>

<script src="/js/auth.js"></script>
<script>
    let csrfReady = false;

    // Initiera CSRF
    async function initializeCsrf() {
        const statusDiv = document.getElementById('csrfStatus');

        try {
            const token = await getCsrfToken();
            if (token) {
                statusDiv.innerHTML = 'üîí CSRF-skydd aktiverat';
                statusDiv.className = 'csrf-info text-center text-success';
                csrfReady = true;
            } else {
                statusDiv.innerHTML = '‚ö†Ô∏è CSRF-token ej tillg√§ngligt';
                statusDiv.className = 'csrf-info text-center text-warning';
            }
        } catch (error) {
            statusDiv.innerHTML = '‚ùå CSRF-fel: ' + error.message;
            statusDiv.className = 'csrf-info text-center text-danger';
        }
    }

    // Initiera n√§r sidan laddas
    document.addEventListener('DOMContentLoaded', async () => {
        await initializeCsrf();
    });

    // L√∂senordsvalidering i realtid
    const passwordInput = document.getElementById('password');
    const confirmPasswordInput = document.getElementById('confirmPassword');

    passwordInput.addEventListener('input', validatePassword);
    confirmPasswordInput.addEventListener('input', checkPasswordMatch);

    function validatePassword() {
        const password = passwordInput.value;

        // L√§ngdkontroll
        const lengthCheck = document.getElementById('lengthCheck');
        if (password.length >= 8) {
            lengthCheck.innerHTML = '‚úÖ Minst 8 tecken';
            lengthCheck.style.color = '#28a745';
        } else {
            lengthCheck.innerHTML = '‚ùå Minst 8 tecken';
            lengthCheck.style.color = '#dc3545';
        }

        // Bokstavskontroll
        const letterCheck = document.getElementById('letterCheck');
        if (/[a-zA-Z]/.test(password)) {
            letterCheck.innerHTML = '‚úÖ Inneh√•ller bokst√§ver';
            letterCheck.style.color = '#28a745';
        } else {
            letterCheck.innerHTML = '‚ùå Inneh√•ller bokst√§ver';
            letterCheck.style.color = '#dc3545';
        }

        // Sifferkontroll
        const numberCheck = document.getElementById('numberCheck');
        if (/\d/.test(password)) {
            numberCheck.innerHTML = '‚úÖ Inneh√•ller siffror';
            numberCheck.style.color = '#28a745';
        } else {
            numberCheck.innerHTML = '‚ùå Inneh√•ller siffror';
            numberCheck.style.color = '#dc3545';
        }

        // Kontrollera om l√∂senorden matchar
        if (confirmPasswordInput.value) {
            checkPasswordMatch();
        }
    }

    function checkPasswordMatch() {
        const password = passwordInput.value;
        const confirmPassword = confirmPasswordInput.value;
        const matchDiv = document.getElementById('passwordMatch');
        const errorDiv = document.getElementById('confirmPasswordError');

        if (confirmPassword && password === confirmPassword) {
            matchDiv.classList.remove('d-none');
            errorDiv.classList.add('d-none');
            confirmPasswordInput.classList.remove('is-invalid');
            confirmPasswordInput.classList.add('is-valid');
        } else if (confirmPassword) {
            matchDiv.classList.add('d-none');
            errorDiv.textContent = 'L√∂senorden matchar inte';
            errorDiv.classList.remove('d-none');
            confirmPasswordInput.classList.add('is-invalid');
            confirmPasswordInput.classList.remove('is-valid');
        }
    }

    // Formul√§rhantering med CSRF
    document.getElementById('registerForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        if (!csrfReady) {
            showAlert('V√§ntar p√• s√§kerhetstoken. F√∂rs√∂k igen om en sekund.', 'warning');
            return;
        }

        // H√§mta v√§rden
        const formData = {
            firstName: document.getElementById('firstName').value,
            lastName: document.getElementById('lastName').value,
            email: document.getElementById('email').value,
            password: document.getElementById('password').value,
            confirmPassword: document.getElementById('confirmPassword').value
        };

        // Validera p√• klientsidan f√∂rst
        if (!validateForm(formData)) {
            return;
        }

        // Visa laddning
        const btn = document.getElementById('registerBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Registrerar...';

        try {
            const response = await registerWithCsrf(formData);
            const data = await response.json();

            if (response.ok && data.success) {
                showAlert('Registrering lyckades! Omdirigerar till inloggning...', 'success');
                setTimeout(() => {
                    window.location.href = '/login.html';
                }, 2000);
            } else {
                // Hantera CSRF-fel
                if (response.status === 403) {
                    showAlert('S√§kerhetsfel. Laddar om sidan...', 'danger');
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    showAlert(data.message || 'Registrering misslyckades', 'danger');

                    // Visa specifika f√§ltfel om de finns
                    if (data.message && data.message.includes('E-post')) {
                        showFieldError('email', data.message);
                    }
                }
            }
        } catch (error) {
            console.error('Registration error:', error);
            showAlert('Ett fel uppstod. F√∂rs√∂k igen senare.', 'danger');
        } finally {
            btn.disabled = false;
            btn.innerHTML = 'Skapa konto';
        }
    });

    function validateForm(data) {
        let isValid = true;

        // Rensa tidigare fel
        document.querySelectorAll('.field-error').forEach(el => {
            el.classList.add('d-none');
            el.textContent = '';
        });
        document.querySelectorAll('.form-control').forEach(el => {
            el.classList.remove('is-invalid');
        });

        // Validera f√∂rnamn
        if (data.firstName.length < 2) {
            showFieldError('firstName', 'F√∂rnamn m√•ste vara minst 2 tecken');
            isValid = false;
        }

        // Validera efternamn
        if (data.lastName.length < 2) {
            showFieldError('lastName', 'Efternamn m√•ste vara minst 2 tecken');
            isValid = false;
        }

        // Validera email
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(data.email)) {
            showFieldError('email', 'Ogiltig e-postadress');
            isValid = false;
        }

        // Validera l√∂senord
        const passwordRegex = /^(?=.*[a-zA-Z])(?=.*\d).{8,}$/;
        if (!passwordRegex.test(data.password)) {
            showFieldError('password', 'L√∂senordet uppfyller inte kraven');
            isValid = false;
        }

        // Kontrollera att l√∂senorden matchar
        if (data.password !== data.confirmPassword) {
            showFieldError('confirmPassword', 'L√∂senorden matchar inte');
            isValid = false;
        }

        return isValid;
    }

    function showFieldError(fieldId, message) {
        const field = document.getElementById(fieldId);
        const errorDiv = document.getElementById(fieldId + 'Error');

        field.classList.add('is-invalid');
        if (errorDiv) {
            errorDiv.textContent = message;
            errorDiv.classList.remove('d-none');
        }
    }

    function showAlert(message, type) {
        const alertBox = document.getElementById('alertBox');
        alertBox.className = `alert alert-${type}`;
        alertBox.textContent = message;
        alertBox.classList.remove('d-none');

        // Scrolla upp till meddelandet
        alertBox.scrollIntoView({ behavior: 'smooth' });
    }